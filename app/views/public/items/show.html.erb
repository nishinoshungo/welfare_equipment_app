<!--<h1>商品詳細</h1>-->
<div class="row">
  <%= render 'public/items/genre', genres: @genres %>
  <div class="col-9">
    <div class="row  border-bottom" style="padding-bottom: 100px;">
      <div class="col d-flex justify-content-center">
        <%= attachment_image_tag @item, :image, :fill, 300, 250, format: 'jpg' %>
      </div>
      <div class="col">
        <table class="table table-borderless">
          <tbody>
            <tr>
              <td><h4><%= @item.name %></h4></td>
            </tr>
            <tr>
              <td><%= @item.price.to_s(:delimited) %>円(税込み)</td>
            </tr>
            <% if customer_signed_in? %>
              <tr>
                <td><%= (@item.price * current_customer.burden_ratio.to_i * 0.1).floor.to_s(:delimited) %>円(<%= current_customer.burden_ratio %>額)</td>
              </tr>
            <% end %>
            <tr>
              <td><%= @item.introduction %></td>
            </tr>
            <tr>
              <td class="review-star" data-score="<%= @item.reviews.average(:rate).to_f.round(1) %>"></td>
            </tr>
            <tr>
              <td>
                <% if customer_signed_in? %>
                  <% if current_customer.already_favorited?(@item) %>
                    <%= link_to "お気に入り解除", destroy_favorite_items_path(item_id: @item.id), method: :delete %>
                  <% else %>
                    <%= link_to "お気に入り登録", create_favorite_items_path(item_id: @item.id), method: :post %>
                  <% end %>
                  (<%= @item.favorite_items.count %>人がお気に入りしています。)
                <% end %>
              </td>
            </tr>
            <tr>
              <td>
                <% if customer_signed_in? %>
                  <%= form_with model: @cart_item, url: '/cart_items', local:true do |f| %>
                    <%= f.number_field :amount, min: 1, max: @item.stock %>
                    <%= f.hidden_field :item_id, value: @item.id %>
                    <%= f.hidden_field :customer_id, value: current_customer.id %>
                    <%= f.submit "カートに入れる", class: "btn btn-success" %>(残り<%= @item.stock %>点)
                  <% end %>
                <% end %>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <% if customer_signed_in? %>
      <div class="mt-5">
        <h5>レビューを投稿する</h5>
        <%= form_with model: @review, url: items_reviews_path(item_id: @item.id), local:true do |f| %>
          <div class="new_star">
            <label>評価</label>
          </div>
          <div class="mt-3">
            <%= f.label :コメント %>
            <%= f.text_area :comment, class: "form-control" %>
          </div>
          <div>
            <%= f.submit "レビュー投稿", class: "btn btn-primary mt-3" %>
          </div>
        <% end %>
      </div>

    <% end %>
    <table class="table mt-5">
      <thead>
        <tr>
          <th>商品レビュー</th>
        </tr>
      </thead>
      <tbody>
        <% @item.reviews.each do |review| %>
          <tr>
            <td>
              <div class="review-star" data-score="<%= review.rate %>"></div>
              <div class="mt-3">
                <p><%= review.comment %></p>
                <p><%= review.created_at %></p>
                <% if customer_signed_in? %>
                  <% if review.customer_id == current_customer.id %>
                    <%= link_to "編集", "/items/reviews/#{review.id}/edit" %>
                    <%= link_to "削除", destroy_review_path(review.id, item_id: @item.id), method: :delete %>
                  <% end %>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

  </div>
</div>



<script>
  $('.new_star').raty({
    size: 36,
    starOn: "<%= asset_path('star-on.png') %>",
    starOff: "<%= asset_path('star-off.png') %>",
    starHalf: "<%= asset_path('star-half.png') %>",
    scoreName: 'review[rate]',
    half: true
  });

  $('.review-star').raty({
    readOnly: true,
    score: function(){
      return $(this).attr('data-score');
    },
    path: '/assets/',
    size: 36
  });

</script>
